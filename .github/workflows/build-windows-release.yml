name: Build Windows Release

on:
  push:
    branches: 
      - master
      - main
  workflow_dispatch:

jobs:
  build-release:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v6
    
    - uses: microsoft/setup-msbuild@v2
    
    - name: Build mpy-cross.exe
      run: msbuild mpy-cross\mpy-cross.vcxproj -maxcpucount -property:Configuration=Release -property:Platform=x64
    
    - name: Update submodules
      run: git submodule update --init lib/micropython-lib
    
    - name: Build micropython.exe
      run: msbuild ports\windows\micropython.vcxproj -maxcpucount -property:Configuration=Release -property:Platform=x64 -property:PyVariant=standard
    
    - name: Get exe path
      id: get_path
      run: |
        $exePath="$(msbuild ports\windows\micropython.vcxproj -nologo -v:m -t:ShowTargetPath -property:Configuration=Release -property:Platform=x64 -property:PyVariant=standard)"
        echo ("micropython=" + $exePath.Trim()) >> $env:GITHUB_OUTPUT
    
    - name: Upload micropython.exe
      uses: actions/upload-artifact@v4
      with:
        name: micropython-windows-x64-release
        path: |
          ${{ steps.get_path.outputs.micropython }}
          mpy-cross/build/x64/Release/mpy-cross.exe
        retention-days: 90
